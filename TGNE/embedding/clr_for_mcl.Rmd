---
title: "clr_for_mcl"
output: html_notebook
---

## Load libraries and set env
```{r}
setwd("~/git/TGNE-2022/TGNE/embedding/")
library(minet)
library(Rgraphviz)
library(igraph)
library(reshape2)
library(Matrix)
library(parmigene)
```

IMPORT THE FILTERED DATA AS A DATAFRAME AND TAKE THE TRANSPOSE

```{r}
data <- read.csv("../microarray_probe_alignment_and_filtering/allgood_filt_agg_tidy_2021aligned_qc_rma_expression_full.csv", header = TRUE, row.names = 1)

data_knn3 <- knnmi.all(data, k=3)
```

BUILD THE NETWORK

```{r}
# mim <- build.mim(data_knn3)
# clr_network <- clr(mim)
clr_network <- clr(data_knn3)
```

COUNT THE NUMBER OF GENES (NODES) AND EDGES IN THE NETWORK

```{r}
network_graph <- graph_from_adjacency_matrix(clr_network, mode = "undirected")

degrees <- degree(network_graph)

non_isolated_vertex_count <- sum(degrees > 0)

num_edges <- ecount(network_graph)

cat("Number of genes in the network:", non_isolated_vertex_count, "\n")
cat("Number of edges in the network:", num_edges, "\n")
```

```{r}
thresholded_zscore_matrix <- clr_network

nums_genes <- numeric()
nums_edges <- numeric()

threshold <- 12

threshold_step1 <- 1
threshold_step2 <- 0.1
threshold_step3 <- 0.01

curr_threshold_step <- threshold_step1

total_genes <- non_isolated_vertex_count
cat(total_genes)

optimal_threshold <- 0

while (TRUE) {
  
  thresholded_zscore_matrix[thresholded_zscore_matrix < threshold] <- 0
  
  thresholded_network_graph <- graph_from_adjacency_matrix(thresholded_zscore_matrix, mode = "undirected")
  
  thresholded_degrees <- degree(thresholded_network_graph)
  
  thresholded_non_isolated_vertex_count <- sum(thresholded_degrees > 0)
  nums_genes <- c(nums_genes, thresholded_non_isolated_vertex_count)
  
  thresholded_num_edges <- ecount(thresholded_network_graph)
  nums_edges <- c(nums_edges, thresholded_num_edges)
  
  cat("              Zscore Threshold:", threshold, "\n")
  cat("Number of genes in the network:", thresholded_non_isolated_vertex_count, "\n")
  cat("Number of edges in the network:", thresholded_num_edges, "\n")
  
  if (all(thresholded_non_isolated_vertex_count != total_genes, curr_threshold_step == threshold_step1)){
    threshold <- threshold - curr_threshold_step
    curr_threshold_step <- threshold_step2
  }
  else if (all(thresholded_non_isolated_vertex_count != total_genes, curr_threshold_step == threshold_step2)){
    threshold <- threshold - curr_threshold_step
    curr_threshold_step <- threshold_step3
  }
  else if (all(thresholded_non_isolated_vertex_count != total_genes, curr_threshold_step == threshold_step3)){
    optimal_threshold <- threshold - curr_threshold_step
    break
  }
  
  threshold <- curr_threshold_step + threshold
}

cat("      Optimal Zscore Threshold:", optimal_threshold, "\n")
```

ISOLATE THE EDGES IN THE NETWORK WITH A ZSCORE >= 3.49 IN NEW DATAFRAME AND COUNT THE NUMBER OF GENES (NODES) AND EDGES IN THE THRESHOLDED NETWORK

```{r}
thresholded_zscore_matrix <- clr_network

thresholded_zscore_matrix[thresholded_zscore_matrix < optimal_threshold] <- 0

thresholded_network_graph <- graph_from_adjacency_matrix(thresholded_zscore_matrix, mode = "undirected")

thresholded_degrees <- degree(thresholded_network_graph)

thresholded_non_isolated_vertex_count <- sum(thresholded_degrees > 0)

thresholded_num_edges <- ecount(thresholded_network_graph)

cat("Number of genes in the network:", thresholded_non_isolated_vertex_count, "\n")
cat("Number of edges in the network:", thresholded_num_edges, "\n")
```

CONVERT THE THRESHOLDED NETWORK TO A MATRIX

```{r}
thresholded_zscore_df <- as.matrix(thresholded_zscore_matrix)
```

CONVERT THE MATRIX TO ABC GRAPH FORMAT AND SAVE TO TXT FILE

```{r}
abc_thresholded_zscore_df <- melt(thresholded_zscore_df)

non_zero_edges <- abc_thresholded_zscore_df[abc_thresholded_zscore_df$value != 0, ]

write.table(non_zero_edges, "./mcl_rcl/abc_format_clr_graph.txt", sep = "\t", quote = FALSE, row.names = FALSE, col.names = FALSE)
```

# ```{r}
# graph <- as(clr_network, "graphNEL")
# plot(graph)
# ```

