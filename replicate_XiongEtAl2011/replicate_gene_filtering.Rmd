---
title: "Gene Filtering for replicating Wei and Jie's 2011 analysis"
output: html_notebook
---

## Load libraries and set env
```{r}
# Assuming that your git repos are setup the same way, but you can change
# this working directory to match whatever setup you have
setwd("~/Documents/git/TGNE-2022/replicate_XiongEtAl2011/")
library(geneplotter)
library(RColorBrewer)
options(stringsAsFactors = FALSE)
```

## Filter dataset
First, load unfiltered data
```{r}
uncorrected <- read.csv(
  './microarray_expression_uncorrected.csv',
  row.names=1
)
unfiltered <- read.csv(
  './microarray_expression_corrected_against_2006_genome.csv', 
  row.names = 1
)
head(uncorrected)
head(unfiltered)
```
Now, take a look a some statistics of variation
```{r}
wei.range.fun <- function(v) {
        return(max(v) - min(v))
}

expr.wei.range <- apply(unfiltered, 1, wei.range.fun)
expr.med <- apply(unfiltered, 1, median)
expr.mean <- apply(unfiltered, 1, mean)
expr.sd <- apply(unfiltered, 1, sd)
expr.cv <- expr.sd / expr.mean

uncorrected.expr.wei.range <- apply(uncorrected, 1, wei.range.fun)
uncorrected.expr.med <- apply(uncorrected, 1, median)
uncorrected.expr.mean <- apply(uncorrected, 1, mean)
uncorrected.expr.sd <- apply(uncorrected, 1, sd)
uncorrected.expr.cv <- uncorrected.expr.sd / uncorrected.expr.mean

```

Visualize histograms of metrics

```{r}
# sizeGrWindow(12,9)
hist(log(uncorrected.expr.wei.range), main='Log Wei Range Hist (uncorrected)', breaks=sqrt(length(uncorrected.expr.wei.range)))
abline(v=quantile(log(uncorrected.expr.wei.range), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(uncorrected.expr.wei.range)), lwd=1, col='blue')

# sizeGrWindow(12,9)
hist(log(expr.wei.range), main='Log Wei Range Hist (2006 corrected)', breaks=sqrt(length(expr.wei.range)))
abline(v=quantile(log(expr.wei.range), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(expr.wei.range)), lwd=1, col='blue')
```

```{r}
# sizeGrWindow(12,9)
hist(log(uncorrected.expr.mean), main='Log Mean Hist (uncorrected)', breaks=sqrt(length(uncorrected.expr.mean)))
abline(v=quantile(log(uncorrected.expr.mean), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(uncorrected.expr.mean)), lwd=1, col='blue')

hist(log(expr.mean), main='Log Mean Hist (2006 corrected)', breaks=sqrt(length(expr.mean)))
abline(v=quantile(log(expr.mean), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(expr.mean)), lwd=1, col='blue')
```

```{r}
# sizeGrWindow(12,9)
hist(log(uncorrected.expr.med), main='Log Med Hist (uncorrected)', breaks=sqrt(length(uncorrected.expr.med)))
abline(v=quantile(log(uncorrected.expr.med), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(uncorrected.expr.med)), lwd=1, col='blue')

hist(log(expr.med), main='Log Med Hist (2006 corrected)', breaks=sqrt(length(expr.med)))
abline(v=quantile(log(expr.med), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(expr.med)), lwd=1, col='blue')
```

```{r}
uncorrected.wei.filter <- (uncorrected.expr.wei.range >= median(uncorrected.expr.wei.range)) | (uncorrected.expr.mean >= median(uncorrected.expr.mean))
wei.filter <- (expr.wei.range >= median(expr.wei.range)) | (expr.mean >= median(expr.mean))

sum(uncorrected.wei.filter)
sum(wei.filter)
```

In their initial analysis, Wei and Jie ended up with 15,091 genes to work with,
starting with 28,064 probes. If I start by correcting against the 2006 genome,
which they had access to at the time, and average probes that mark the same
gene, I start with 25,767 genes. It's reasonable to expect that I would
have fewer genes after the filter. I'm not sure why I have 5 more genes than they
did...

```{r}
uncorrected.filtered = uncorrected[uncorrected.wei.filter,]
filtered <- unfiltered[wei.filter,]
```

```{r}
uncorrected.filtered.expr.wei.range <- apply(uncorrected.filtered, 1, wei.range.fun)
uncorrected.filtered.expr.med <- apply(uncorrected.filtered, 1, median)
uncorrected.filtered.expr.mean <- apply(uncorrected.filtered, 1, mean)
uncorrected.filtered.expr.sd <- apply(uncorrected.filtered, 1, sd)
uncorrected.filtered.expr.cv <- uncorrected.filtered.expr.sd / uncorrected.filtered.expr.mean


filtered.expr.wei.range <- apply(filtered, 1, wei.range.fun)
filtered.expr.med <- apply(filtered, 1, median)
filtered.expr.mean <- apply(filtered, 1, mean)
filtered.expr.sd <- apply(filtered, 1, sd)
filtered.expr.cv <- filtered.expr.sd / filtered.expr.mean
```


```{r}
# sizeGrWindow(12,9)
hist(log(uncorrected.filtered.expr.wei.range), main='Log Wei Range Hist of (uncorrected) filtered dataset', breaks=sqrt(length(uncorrected.filtered.expr.wei.range)))
abline(v=quantile(log(uncorrected.filtered.expr.wei.range), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(uncorrected.filtered.expr.wei.range)), lwd=1, col='blue')

hist(log(filtered.expr.wei.range), main='Log Wei Range Hist of (2006 corrected) filtered dataset', breaks=sqrt(length(filtered.expr.wei.range)))
abline(v=quantile(log(filtered.expr.wei.range), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(filtered.expr.wei.range)), lwd=1, col='blue')
```

```{r}
# sizeGrWindow(12,9)
hist(log(uncorrected.filtered.expr.mean), main='Log Mean Hist of (uncorrected) filtered dataset', breaks=sqrt(length(uncorrected.filtered.expr.mean)))
abline(v=quantile(log(uncorrected.filtered.expr.mean), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(uncorrected.filtered.expr.mean)), lwd=1, col='blue')

hist(log(filtered.expr.mean), main='Log Mean Hist of (2006 corrected) filtered dataset', breaks=sqrt(length(filtered.expr.mean)))
abline(v=quantile(log(filtered.expr.mean), probs=c(0.1)), lwd=1, col='red')
abline(v=median(log(filtered.expr.mean)), lwd=1, col='blue')
```

```{r}
# sizeGrWindow(12,9)
blues.ramp <- colorRampPalette(brewer.pal(9,"Blues")[-1])
dCol <- densCols(log(uncorrected.expr.mean),
                 log(uncorrected.expr.cv),
                 colramp=blues.ramp)
plot(uncorrected.expr.mean, uncorrected.expr.cv, main='Coef. Var. vs. Mean Expr. of (uncorrected) unfiltered data', log='xy', col=dCol, pch=16, cex=0.1)

blues.ramp <- colorRampPalette(brewer.pal(9,"Blues")[-1])
dCol <- densCols(log(expr.mean),
                 log(expr.cv),
                 colramp=blues.ramp)
plot(expr.mean, expr.cv, main='Coef. Var. vs. Mean Expr. of (2006 corrected) unfiltered data', log='xy', col=dCol, pch=16, cex=0.1)
```

```{r}
# sizeGrWindow(12,9)
blues.ramp <- colorRampPalette(brewer.pal(9,"Blues")[-1])
dCol <- densCols(log(uncorrected.filtered.expr.mean),
                 log(uncorrected.filtered.expr.cv),
                 colramp=blues.ramp)
plot(uncorrected.filtered.expr.mean, uncorrected.filtered.expr.cv, main='Coef. Var. vs. Mean Expr. of (uncorrected) filtered data', log='xy', col=dCol, pch=16, cex=0.1)

blues.ramp <- colorRampPalette(brewer.pal(9,"Blues")[-1])
dCol <- densCols(log(filtered.expr.mean),
                 log(filtered.expr.cv),
                 colramp=blues.ramp)
plot(filtered.expr.mean, filtered.expr.cv, main='Coef. Var. vs. Mean Expr. of (2006 corrected) filtered data', log='xy', col=dCol, pch=16, cex=0.1)
```
Wei and Jie went on to take log2 of the data
```{r}
log2.uncorrected.filtered <- log2(uncorrected.filtered)
log2.uncorrected.expr.mean <- apply(log2.uncorrected.filtered, 1, mean)
log2.uncorrected.expr.sd <- apply(log2.uncorrected.filtered, 1, sd)
log2.uncorrected.expr.cv <- log2.uncorrected.expr.sd / log2.uncorrected.expr.mean


log2.filtered <- log2(filtered)
log2.expr.mean <- apply(log2.filtered, 1, mean)
log2.expr.sd <- apply(log2.filtered, 1, sd)
log2.expr.cv <- log2.expr.sd / log2.expr.mean
```

```{r}
# sizeGrWindow(12,9)
blues.ramp <- colorRampPalette(brewer.pal(9,"Blues")[-1])
dCol <- densCols(log2.uncorrected.expr.mean,
                 log2.uncorrected.expr.cv,
                 colramp=blues.ramp)
plot(log2.uncorrected.expr.mean, log2.uncorrected.expr.cv, main='Coef. Var. vs. Mean Expr. of log2-transformed (uncorrected) filtered data', col=dCol, pch=16, cex=0.1)

blues.ramp <- colorRampPalette(brewer.pal(9,"Blues")[-1])
dCol <- densCols(log2.expr.mean,
                 log2.expr.cv,
                 colramp=blues.ramp)
plot(log2.expr.mean, log2.expr.cv, main='Coef. Var. vs. Mean Expr. of log2-transformed (2006 corrected) filtered data', col=dCol, pch=16, cex=0.1)
```
There is a definite heteroskedasticity that this log2-transformation
introduced, which may interfere with co-expression analysis.

It looks like the log2 transform of filtered uncorrected expression data fully
aligns with what Wei and Jie did in 2011, so I will proceed with that.
Return to analysis/replicate_TGN-2011/microarray_probe_correction_replicating2011analysis.ipynb 
to see if renaming these genes makes sense.
```{r}
write.csv(log2.uncorrected.filtered, './TGN_2011_replicate_expression_dataset.csv')
head(log2.uncorrected.filtered)
```